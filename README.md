# 太极图形课S1-3D贪吃蛇

## 作业来源
> 这个想法是在12月18日凌晨3点30分，躺在床上的时候构思得到的。当时想到的最终成品的几个要素是这样：
   1. 想要做一个3D的成品（运用到渲染的技术）
   2. 想要复刻一个童年经典
   3. 想要做一个互动性质的游戏
> 在思考了几个"2D迷宫", "labyrinth", "badland"这样几个选项之后最终选择了最简单的"贪吃蛇"。

## 运行方式
> `python main.py`
> WASD和左键右键是旋转，空格键是前进

## 效果展示
> [这个动图](data/4a53h-ux9wl.gif)

## 整体结构
> 脉络清晰的结构能完整展示你的设计思想，以及实现方式，方便读者快速代入。Python的代码，可以使用命令：`yapf -i xx.py`来格式化。可以在repo的目录中包含如下内容：
```
-LICENSE
-|data
-README.MD
-main.py   # 主程序，包含了大部分的控制内容
-ray_tracing_utils.py  # 和光追相关的组件
-Rotation.py    # 一个控制旋转的单独的类
```

## 实现细节：
本项目从Ray Tracing项目作为起点，一步步的向上迭代，替换不同组件，直到变成现在这个样子。

### 摄像机的旋转实现
> 首先是参考了课程中Ray Tracer一课中的样例Camera，实现了一个固定机位。然后试图寻找一个可以通过键盘/鼠标来操控摄像机转动的办法。
> 一开始试图使用[Arcball] (https://graphicsinterface.org/wp-content/uploads/gi1992-18.pdf) 来实现这一旋转功能，然而尝试后（可以checkout到8f645b commit来观察）发现Arcball在使用鼠标拖动时在经过画面中间时会产生抖动。之后查询网上的[Demo](https://magnum.graphics/showcase/arcball/)猜测Arcball适用于旋转一个*在面前的物体*而非视角本身。因此放弃了使用arcball的方法。关于arcball的尝试，单开了一个[repo](https://github.com/bjmiao/taichi_arcball)，写了一个样例。
> 在学习Arcball算法的过程中了解了旋转矩阵等概念，发现其实可以把摄像机旋转分解为沿着三根坐标轴分别的旋转。因此，目前的旋转控制是每个time step，沿着当前摄像机的u/v/w轴旋转一定角度完成的。这边套用了[某个向量沿着某根坐标轴的旋转矩阵](https://en.wikipedia.org/wiki/Rotation_matrix#Rotation_matrix_from_axis_and_angle)的公式。实现出来了一个还比较炫酷的旋转控制。

### 光照模型
> 由于这个游戏中并没有“上下左右”之分，因此我并没有设置一个固定光源，而是假定这条“贪吃蛇”的头上（也就是摄像机的位置）设置了一个理想的点光源。根据物理知识，设定了光照强度随着距离成平方反比（设定一个最小阈值），从摄像机射出去的光等于墙面颜色乘以光照强度的一个系数。因此可以看到如下图这样的光照效果（莫名感觉这种渲染效果在我小时候很多的粗糙的3D游戏里面也会见到）
> [光照示意图](data/light.jpg)

### 其他代码细节
> 在若干地方实现了手动inline（例如判断光线设在平面内时把计算三角形面积的部分给inline了，以及没有使用一个正方体类套六个平面类）来减少初始化（猜测是用于JIT编译）的时间。
> 没有选择在taichi-scope中管理状态（比如摄像机状态，游戏状态，食物位置等），而是选择在CPU上管理状态，之后通过taichi kernel给赋值到taichi-scope内，交由GPU渲染。
> 如何实现一个平滑的“长按某个键连续旋转/前进”：发现如果用单纯的GUI.PRESS来判断，会在第一次旋转和第二次旋转之间有一个延时。这个就像是在记事本里面长按a键的时候，第1个a和第2个a打出来会有0.5s左右的延时，非常不顺滑。因此采用了分别记录GUI.PRESS和GUI.RELEASE事件，判断按键状态来实现一个顺滑的旋转。